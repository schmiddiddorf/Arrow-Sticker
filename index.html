<!doctype html>
<html lang="de">
  <head>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Arrow-Sticker RC3</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #e0e0e0;
      }
      #app {
        max-width: 900px;
        margin: auto;
      }
      #previewWrap {
        background: #777;
        padding: 8px;
      }
      #preview {
        background: #353535;
        display: block;
        margin: 0 auto;
      }
      .tabs {
        align-content: center;
        display: flex;
        gap: 4px;
        padding: 8px;
        background: #ddd;
      }
      .tab {
        align-content: center;
        padding: 6px 10px;
        border: 1px solid #aaa;
        cursor: pointer;
        background: #f0f0f0;
      }
      .tab.active {
        background: white;
        font-weight: bold;
      }
      .panel {
        max-width: 900px;
        align-content: center;
        display: none;
        padding: 10px;
        background: #f7f7f7;
        border: 1px solid #ccc;
      }
      .row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 6px 0;
        flex-wrap: wrap;
      }
      .row label {
        min-width: 120px;
      }
      input[type="range"] {
        flex: 1;
        min-width: 10px;
        max-width: 100px;
      }
      .frame-inline {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-left: 0;
      }
      .frame-inline input {
        width: 16px;
        height: 16px;
        margin: 0 4px 0 0;
      }
      .hidden {
        display: none;
      }

      .preview-controls label {
        white-space: nowrap;
        cursor: pointer;
      }
      #app {
        display: flex;
        flex-direction: column;
      }
      #previewWrap {
        background: #777;
        padding: 8px;
      }
      .controls-area {
        flex: 1 1 auto;
        overflow-y: auto;
        max-height: calc(100vh - 120px);
      }
      .range-wrap {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .pm {
        width: 26px;
        height: 26px;
        font-size: 16px;
        cursor: pointer;
      }
      #preview-wrapper {
        flex: 0 0 45%; /* Vorschau bleibt links fixiert */
        max-width: 45%;
      }
      #ui-area {
        flex: 1;
        overflow-x: auto; /* UI darf horizontal scrollen */
      }
      .sheet-info {
        font-size: 13px;
        color: #440000;
        line-height: 1.5;
      }
      .session-banner {
        background: #ffd966;
        color: #222;
        padding: 6px 10px;
        text-align: center;
        font-size: 13px;
        border-bottom: 1px solid #aaa;
      }

      .session-banner.hidden {
        display: none;
      }
      .btn-small {
        float: right;
        padding: 4px 8px;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div id="sessionBanner" class="session-banner hidden">
  üîÑ Letzte Sitzung wiederhergestellt
    </div>
    <div id="app">
      <div id="previewWrap">
        <svg id="preview" width="340" height="200" viewBox="0 0 100 50"></svg>
      </div>

      <div class="controls-area">
        <div class="controls-inner" style="width: 100%">
          <!-- Tabs -->
          <div class="tabs">
            <button class="tab active" data-tab="allgemein">Allgemein</button>
            <button class="tab" data-tab="schrift">Schrift</button>
            <button class="tab" data-tab="icon">Extras</button>
            <button class="tab" data-tab="export">Export</button>
          </div>
        </div>

        <!-- Panel Allgemein -->
        <div id="allgemein" class="panel" style="display: block">
          <h3>Infos<button id="resetSessionBtn" class="btn-small">Reset</button></h3>

          
          
          
          <div class="row">
            <label>Pfeilmarke / Typ</label>
            <input id="arrowType" placeholder="z.B. Easton X10" />
          </div>

          <div class="row">
            <label>Spine</label>
            <input id="spine" placeholder="z.B. 500" />
          </div>

          <div class="row">
            <label>Pfeildurchmesser</label>
            <div class="range-wrap">
              <button type="button" class="pm" data-target="arrowDia" data-step="-0.01">‚àí</button>
              <input type="range" id="arrowDia" min="3.2" max="10.3" step="0.01" value="5" />
              <button type="button" class="pm" data-target="arrowDia" data-step="+0.01">+</button>
            </div>
            <span id="arrowDiaVal">5.00 mm</span>
          </div>

          <hr />

          <h3>Sticker Layout</h3>

          <div class="row">
            <label>Sticker Breite</label>
            <div class="range-wrap">
              <button type="button" class="pm" data-target="stickerW" data-step="-0.1">‚àí</button>
              <input id="stickerW" type="range" min="10" max="45" step="0.1" value="35" />
              <button type="button" class="pm" data-target="stickerW" data-step="0.1">+</button>
            </div>
            <span id="stickerWVal">30 mm</span>
          </div>

          <div class="row">
            <label>Extra H√∂he</label>
            <div class="range-wrap">
              <button type="button" class="pm" data-target="extraH" data-step="-0.1">‚àí</button>
              <input id="extraH" type="range" min="0" max="2" step="0.1" value="0.5" />
              <button type="button" class="pm" data-target="extraH" data-step="0.1">+</button>
            </div>
            <span id="extraHVal">0.5 mm</span>
          </div>

          <div class="row">
            <label>Extras</label> <input type="checkbox" id="iconOn" checked />Icon
            <input type="checkbox" id="circleOn" checked />Nummerirung
          </div>

          <div class="row">
            <label>Hintergrund</label>
            <input type="color" id="bgColor" value="#ffffff" />
          </div>

          <div class="row">
            <label>Rahmen</label>
            <div class="frame-inline">
              <input type="checkbox" id="frameTop" />O <input type="checkbox" id="frameBottom" />U
              <input type="checkbox" id="frameLeft" />L <input type="checkbox" id="frameRight" />R
            </div>
          </div>

          <div class="row"><label>Rahmenfarbe</label><input type="color" id="frameColor" value="#000000" /></div>

          <div class="row">
            <label>Rahmenbreite</label>
            <div class="range-wrap">
              <button type="button" class="pm" data-target="frameWidth" data-step="-0.1">‚àí</button>
              <input id="frameWidth" type="range" min="0" max="10" step="0.1" value="0.5" />
              <button type="button" class="pm" data-target="frameWidth" data-step="0.1">+</button>
              <span id="frameWidthVal">0.50 mm</span>
            </div>
          </div>

          <!-- END Allgemein -->
        </div>

        <!-- Panel Schrift -->
        <div id="schrift" class="panel">
          <h3>Beschriftung</h3>

          <div class="row"><label>Name</label><input id="name" placeholder="Name" /></div>

          <div class="row"><label>Schriftfarbe</label><input type="color" id="nameColor" value="#000000" /></div>

          <div class="row">
            <label>Anzahl Namen</label>
            <select id="count">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
          </div>

          <div class="row">
            <label>Name Position</label>
            <div class="range-wrap">
              <button type="button" class="pm" data-target="textShift" data-step="-0.1">-</button>
              <input id="textShift" type="range" min="-20" max="20" step="0.1" value="-4" />
              <button type="button" class="pm" data-target="textShift" data-step="0.1">+</button>
              <span id="textShiftVal">0 mm</span>
            </div>
          </div>

          <div class="row">
            <label>Schriftart</label>
            <select id="fontFamily">
              <option>Arial</option>
              <option>Helvetica</option>
              <option>Roboto</option>
              <option>Noto Sans</option>
              <option>Segoe UI</option>
            </select>
          </div>

          <div class="row">
            <label>Schriftgr√∂√üe</label>
            <div class="range-wrap">
              <button type="button" class="pm" data-target="fontSize" data-step="-0.1">‚àí</button>
              <input id="fontSize" type="range" min="1" max="15" step="0.1" value="3" />
              <button type="button" class="pm" data-target="fontSize" data-step="0.1">+</button>
              <span id="fontSizeVal">3 mm</span>
            </div>
          </div>

          <div class="row">
            <label>Bold</label><input type="checkbox" id="fontBold" />Name
            <input type="checkbox" id="fontBoldNum" checked />Nummer
          </div>

          <!-- END Schrift -->
        </div>

        <!-- Panel Icon -->
        <div id="icon" class="panel">
          <h3>Nummerirung</h3>
          <div class="row">
            <label>Form</label>
            <select id="circleShape">
              <option value="circle">Kreis</option>
              <option value="capsule">Langloch</option>
            </select>
          </div>

          <div class="row">
            <label>Kreis</label>
            <div>
              <input type="color" id="circleFill" value="#ffffff" /> F√ºllung
              <input type="color" id="circleStroke" value="#000000" /> Rand
            </div>
          </div>

          <div class="row">
            <label>Nummer Farbe</label>
            <div><input type="color" id="numColor" value="#000000" /></div>
          </div>

          <div class="row">
            <label>Durchmesser</label>
            <div class="range-wrap">
              <button type="button" class="pm" data-target="circleDia" data-step="-0.1">‚àí</button>
              <input id="circleDia" type="range" min="1" max="10" step="0.1" value="3" />
              <button type="button" class="pm" data-target="circleDia" data-step="0.1">+</button>
              <span id="circleDiaVal">3 mm</span>
            </div>
          </div>

          <div class="row">
            <label>Langloch Breite</label>
            <div class="range-wrap">
              <button type="button" class="pm" data-target="capsuleW" data-step="-0.1">-</button>
              <input id="capsuleW" type="range" min="2" max="15" step="0.1" value="5" />
              <button type="button" class="pm" data-target="capsuleW" data-step="0.1">+</button>
              <span id="capsuleWVal"> 5 mm</span>
            </div>
          </div>

          <div class="row">
            <label>Abstand</label>
            <div class="range-wrap">
              <button type="button" class="pm" data-target="circleGap" data-step="-0.1">-</button>
              <input id="circleGap" type="range" min="0" max="20" step="0.1" value="13" />
              <button type="button" class="pm" data-target="circleGap" data-step="0.1">+</button>
              <span id="circleGapVal"> 2 mm</span>
            </div>
          </div>

          <div class="row">
            <label>Kreis vertikal</label>
            <div class="range-wrap">
              <button type="button" class="pm" data-target="circleVOffset" data-step="-0.1">-</button>
              <input id="circleVOffset" type="range" min="-0.5" max="0.5" step="0.1" value="-0.2" />
              <button type="button" class="pm" data-target="circleVOffset" data-step="0.1">+</button>
              <span id="circleVOffsetVal"> 0 mm</span>
            </div>
          </div>

          <div class="row">
            <label>Nummer vertikal</label>
            <div class="range-wrap">
              <button type="button" class="pm" data-target="numVOffset" data-step="-0.1">‚àí</button>
              <input id="numVOffset" type="range" min="-0.5" max="0.5" step="0.1" value="0.1" />
              <button type="button" class="pm" data-target="numVOffset" data-step="0.1">+</button>
              <span id="numVOffsetVal">0 mm</span>
            </div>
          </div>

          <div class="row">
            <label>Kreis Seite</label>
            <div>
              <input type="radio" name="circleSide" value="left" checked /> L
              <input type="radio" name="circleSide" value="right" /> R
            </div>
          </div>
          <hr />
          <h3>Icon</h3>

          <div class="row">
            <label>Emoji</label>
            <!--     <input id="emoji" size="1" >   -->

            <select id="emoji">
              <optgroup label="üè≥Ô∏è L√§nder Europa">
                <option value="üá©üá™">Deutschland üá©üá™</option>
                <option value="üá´üá∑">Frankreich üá´üá∑</option>
                <option value="üáÆüáπ">Italien üáÆüáπ</option>
                <option value="üá™üá∏">Spanien üá™üá∏</option>
                <option value="üá≥üá±">Niederlande üá≥üá±</option>
                <option value="üá®üá≠">Schweiz üá®üá≠</option>
                <option value="üá¶üáπ">√ñsterreich üá¶üáπ</option>
                <option value="üá∏üá™">Schweden üá∏üá™</option>
                <option value="üá≥üá¥">Norwegen üá≥üá¥</option>
                <option value="üá´üáÆ">Finnland üá´üáÆ</option>
              </optgroup>
              <optgroup label="üåç Welt">
                <option value="üá∫üá∏">USA üá∫üá∏</option>
                <option value="üá®üá¶">Kanada üá®üá¶</option>
                <option value="üáØüáµ">Japan üáØüáµ</option>
                <option value="üá®üá≥">China üá®üá≥</option>
                <option value="üá¶üá∫">Australien üá¶üá∫</option>
                <option value="üáßüá∑">Brasilien üáßüá∑</option>
              </optgroup>
              <optgroup label="üèπ Bogensport">
                <option value="üèπ">Bogen üèπ</option>
                <option value="üéØ">Ziel üéØ</option>
                <option value="‚û∂">Pfeil gebogen ‚û∂</option>
                <option value="‚û§">Pfeil ‚û§</option>
                <option value="‚û≥">Pfeil ‚û≥</option>
                <option value="üõ°Ô∏è">Schild üõ°Ô∏è</option>
              </optgroup>
            </select>
          </div>

          <div class="row">
            <label>Icon Gr√∂√üe</label>
            <div class="range-wrap">
              <button type="button" class="pm" data-target="iconSize" data-step="-0.1">‚àí</button>
              <input id="iconSize" type="range" min="1" max="15" step="0.1" value="3" />
              <button type="button" class="pm" data-target="iconSize" data-step="0.1">+</button>
            </div>
            <span id="iconSizeVal">3 mm</span>
          </div>

          <div class="row">
            <label>Icon Abstand</label>
            <div class="range-wrap">
              <button type="button" class="pm" data-target="iconGap" data-step="-0.1">‚àí</button>
              <input id="iconGap" type="range" min="0" max="20" step="0.1" value="7" />
              <button type="button" class="pm" data-target="iconGap" data-step="0.1">+</button>
              <span id="iconGapVal">2 mm</span>
            </div>
          </div>
          <div class="row">
            <label>Icon vertikal</label>
            <div class="range-wrap">
              <button type="button" class="pm" data-target="iconVOffset" data-step="-0.1">‚àí</button>
              <input id="iconVOffset" type="range" min="-0.5" max="0.5" step="0.05" value="-0.25" />
              <button type="button" class="pm" data-target="iconVOffset" data-step="0.1">+</button>
              <span id="iconVOffsetVal">0 mm</span>
            </div>
          </div>
          <div class="row">
            <label>Icon Seite</label>
            <div>
              <input type="radio" name="iconSide" value="left" /> L
              <input type="radio" name="iconSide" value="right" checked /> R
            </div>
          </div>

          <!-- END Icon -->
        </div>

        <!-- Panel Export -->
        <div id="export" class="panel" style="display: block">
          <div class="row">
            <h3>Export Settings</h3>
            <div class="range-wrap"><input type="checkbox" id="toggleAnalyze" />Analyse</div>
          </div>

          <div class="row">
            <label>Nummernmodus</label>
            <select id="numMode">
              <option value="1-12">1 Set 1‚Äì12 + 2 x leer</option>
              <option value="1x1-6">1 Set 1‚Äì6 + 2 x leer</option>
              <option value="2x1-6">2 Sets 1‚Äì6 + 2 x leer</option>
              <option value="2x1-3">2 Sets 1‚Äì3 + 2 x leer</option>
              <option value="4x1-3">4 Sets 1‚Äì3 + 2 x leer</option>
              <option value="leer">leer</option>
            </select>
          </div>
          <hr />

          <div id="analyzeBox">
            <div class="row">
              <label>Analyse</label>
              <div id="sheetInfo" class="sheet-info">-</div>
            </div>
            <div class="row">
              <label>Nummer Test</label>
              <div class="range-wrap">
                <button type="button" class="pm" data-target="stickerIndex" data-step="-1">-</button>
                <input type="range" id="stickerIndex" min="1" max="12" step="1" value="1" />
                <button type="button" class="pm" data-target="stickerIndex" data-step="1">+</button>
                <span id="stickerIndexVal">1</span>
              </div>
            </div>
            <div class="row">
              <button id="exportSingleSvg">Einzel-Sticker</button>
            </div>
          </div>

          <div class="row">
            <label>Reihen f√ºllen mit:</label>
            <select id="extraRowMode">
              <option value="empty">Leer</option>
              <option value="circleOnly">Kreis ohne Nummer</option>
              <option value="meta">Metadaten</option>
            </select>
          </div>

          <hr />

          <div class="row">
            <label>Preset speichern und laden</label>
          </div>

          <div class="row">
            <button id="savePresetBtn">Speichern</button> /
            <input type="file" id="loadPresetFile" accept=".json" />
          </div>

          <hr />

          <div class="export-row">
            <button id="exportSheetSvg">SVG Bogen</button>
            <button id="exportSheetPdf">PDF Bogen</button>
            <button id="exportSheetPng">PNG Bogen</button>
          </div>

          <!-- END Export -->
        </div>
      </div>

      <!-- end controls-area -->
    </div>
    <script>
      let suppressAnalysis = false;
      let suppressNum = false;
      let currentStickerIndex = 0;
      let currentPresetId = null;

      function safeFilePart(str) {
        return String(str || "")
          .trim()
          .replace(/\s+/g, "_")
          .replace(/[^a-zA-Z0-9_\-]/g, "");
      }
      // Banner anzeigen 
      

      
      // END Banner anzeigen
      
      
      
      // Preset ID erzeugen

      function generatePresetId() {
        const ts = Date.now().toString().slice(-5);
        return "STK-" + ts;
      }

      // END Preset ID erzeugen

      function emojiToCodepoint(emoji) {
        const codepoints = [];
        for (const ch of [...emoji]) {
          codepoints.push(ch.codePointAt(0).toString(16));
        }
        return codepoints.join("-");
      }

      // ---------- TAB HANDLING ----------
      document.querySelectorAll(".tab").forEach((t) => {
        t.addEventListener("click", () => {
          document.querySelectorAll(".tab").forEach((x) => x.classList.remove("active"));
          document.querySelectorAll(".panel").forEach((p) => (p.style.display = "none"));
          t.classList.add("active");
          document.getElementById(t.dataset.tab).style.display = "block";
        });
      });

      const mm = (v) => parseFloat(v);

      // ---------- POSITIONS FOR 1/2/3 NAMES ----------
      function computePositions(h, c) {
        if (c === 1) return [h * 0.5];
        if (c === 2) return [h * 0.25, h * 0.75];
        return [h * 0.167, h * 0.5, h * 0.833];
      }

      //----------- Sticker Redering ------------------

      function renderStickerSVG(stickerIndex, options = {}) {
        suppressAnalysis = true;

        // ‚úÖ suppressNum VOR dem Rendern setzen
        suppressNum = options.suppressNumber === true;

        updatePreview(stickerIndex);

        const preview = document.getElementById("preview");

        const vb = preview.getAttribute("viewBox").split(" ");
        const w = Number(vb[2]);
        const h = Number(vb[3]);

        const svg = preview.innerHTML;

        suppressAnalysis = false;

        return { svg, w, h };
      }

      //------------ End Sticker Rendering ------------

      // ------------ Preview --------------------
      // ---------- SINGLE SOURCE OF TRUTH ----------

      function updatePreview(forcedIndex = null) {
        const stickerIndex =
          forcedIndex !== null ? forcedIndex : parseInt(document.getElementById("stickerIndex")?.value || "1", 10) - 1;

        const name = document.getElementById("name").value || "Name";
        const nameColor = document.getElementById("nameColor").value;
        const w = mm(document.getElementById("stickerW").value);
        const h = mm(document.getElementById("arrowDia").value) * Math.PI + mm(document.getElementById("extraH").value);
        const fontSize = mm(document.getElementById("fontSize").value || 3);
        const c = parseInt(document.getElementById("count").value, 10);

        const circleFill = document.getElementById("circleFill").value;
        const circleStroke = document.getElementById("circleStroke").value;
        const numColor = document.getElementById("numColor").value;

        const positions = computePositions(h, c);

        let svg = `<rect x="0" y="0" width="${w}" height="${h}" 
              fill="${document.getElementById("bgColor").value}"/>`;

        // ---- RAHMEN (w√§chst NUR nach innen) ----
        const fw = mm(document.getElementById("frameWidth").value);
        const fc = document.getElementById("frameColor").value;

        if (document.getElementById("frameTop").checked) {
          svg += `<line x1="0" y1="${fw / 2}" x2="${w}" y2="${fw / 2}"
              stroke="${fc}" stroke-width="${fw}"/>`;
        }
        if (document.getElementById("frameBottom").checked) {
          svg += `<line x1="0" y1="${h - fw / 2}" x2="${w}" y2="${h - fw / 2}"
              stroke="${fc}" stroke-width="${fw}"/>`;
        }
        if (document.getElementById("frameLeft").checked) {
          svg += `<line x1="${fw / 2}" y1="0" x2="${fw / 2}" y2="${h}"
              stroke="${fc}" stroke-width="${fw}"/>`;
        }
        if (document.getElementById("frameRight").checked) {
          svg += `<line x1="${w - fw / 2}" y1="0" x2="${w - fw / 2}" y2="${h}"
              stroke="${fc}" stroke-width="${fw}"/>`;
        }

        positions.forEach((y, i) => {
          const baseX = w / 2;
          const textShift = parseFloat(document.getElementById("textShift").value || 0);
          const textX = baseX + textShift;

          // NAME
          svg += `<text x="${textX}" y="${y}" 
            text-anchor="middle" dominant-baseline="middle"
            font-size="${fontSize}"
            font-family="${document.getElementById("fontFamily").value}"
            font-weight="${document.getElementById("fontBold").checked ? "bold" : "normal"}"
            fill="${nameColor}">${name}</text>`;

          // ICON (Twemoji SVG)
          if (document.getElementById("iconOn").checked) {
            const gap = mm(document.getElementById("iconGap").value);
            const size = mm(document.getElementById("iconSize").value);
            const vOff = mm(document.getElementById("iconVOffset").value);

            const iconSide = document.querySelector('input[name="iconSide"]:checked').value;

            const iconX = iconSide === "right" ? baseX + gap : baseX - gap;

            const emojiVal = document.getElementById("emoji").value;
            const cp = emojiToCodepoint(emojiVal);

            const url = `https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/svg/${cp}.svg`;

            svg += `<image
              x="${iconX - size / 2}"
              y="${y + vOff - size / 2}"
              width="${size}"
              height="${size}"
              href="${url}" />`;
          }

          // CIRCLE / CAPSULE + NUMBER (mit Feintuning)
          if (document.getElementById("circleOn").checked) {
            const d = mm(document.getElementById("circleDia").value);
            const r = d / 2;
            const gap = mm(document.getElementById("circleGap").value);
            const vOff = mm(document.getElementById("circleVOffset").value);
            const circleSide = document.querySelector('input[name="circleSide"]:checked').value;
            const cx = circleSide === "right" ? baseX + gap + r : baseX - gap - r;
            const cy = y + vOff;
            const numVOffset = document.getElementById("numVOffset");
            const numYOffset = mm(numVOffset.value);

            if (document.getElementById("circleShape").value === "circle") {
              svg += `<circle cx="${cx}" cy="${cy}" r="${r}"
                fill="${circleFill}"
                stroke="${circleStroke}"
                stroke-width="0.3"/>`;
            } else {
              const capW = mm(document.getElementById("capsuleW").value);
              svg += `<rect x="${cx - capW / 2}" y="${cy - r}"
                width="${capW}" height="${d}" rx="${r}" ry="${r}"
                fill="${circleFill}"
                stroke="${circleStroke}"
                stroke-width="0.3"/>`;
            }

            let numText = "";
            const mode = document.getElementById("numMode").value;

            if (!suppressNum) {
              if (mode === "1-12") numText = String((stickerIndex % 12) + 1);
              if (mode === "1x1-6") numText = String((stickerIndex % 6) + 1);
              if (mode === "2x1-6") numText = String((stickerIndex % 6) + 1);
              if (mode === "2x1-3") numText = String((stickerIndex % 3) + 1);
              if (mode === "4x1-3") numText = String((stickerIndex % 3) + 1);
            }

            if (numText) {
              svg += `<text x="${cx}" y="${cy + numYOffset}"
                text-anchor="middle" dominant-baseline="middle"
                font-size="${Math.max(1, fontSize - 1)}"
                font-weight="${document.getElementById("fontBoldNum").checked ? "bold" : "normal"}"
                fill="${numColor}">${numText}</text>`;
            }
          }
        });

        // ---- FINAL SVG OUTPUT ----
        const preview = document.getElementById("preview");
        preview.setAttribute("viewBox", `0 0 ${w} ${h}`);
        while (preview.firstChild) {
          preview.removeChild(preview.firstChild);
        }
        preview.insertAdjacentHTML("beforeend", svg);

        // update value labels

        document.getElementById("stickerWVal").textContent = w + " mm";
        document.getElementById("arrowDiaVal").textContent =
          parseFloat(document.getElementById("arrowDia").value).toFixed(2) + " mm";
        document.getElementById("extraHVal").textContent = document.getElementById("extraH").value + " mm";
        document.getElementById("iconSizeVal").textContent = document.getElementById("iconSize").value + " mm";
        document.getElementById("iconGapVal").textContent = document.getElementById("iconGap").value + " mm";
        document.getElementById("iconVOffsetVal").textContent = document.getElementById("iconVOffset").value + " mm";
        document.getElementById("circleDiaVal").textContent = document.getElementById("circleDia").value + " mm";
        document.getElementById("capsuleWVal").textContent = document.getElementById("capsuleW").value + " mm";
        document.getElementById("circleGapVal").textContent = document.getElementById("circleGap").value + " mm";
        document.getElementById("circleVOffsetVal").textContent =
          document.getElementById("circleVOffset").value + " mm";
        document.getElementById("numVOffsetVal").textContent = document.getElementById("numVOffset").value + " mm";
        document.getElementById("frameWidthVal").textContent =
          parseFloat(document.getElementById("frameWidth").value).toFixed(2) + " mm";
        document.getElementById("fontSizeVal").textContent = document.getElementById("fontSize").value + " mm";
        document.getElementById("textShiftVal").textContent = document.getElementById("textShift").value + " mm";
        document.getElementById("stickerIndexVal").textContent = stickerIndex + 1;

        // Anlyse Sheet
        if (!suppressAnalysis) {
          analyzeSheet();
        }
      }

      document.querySelectorAll(".pm").forEach((btn) => {
        btn.addEventListener("click", () => {
          const targetId = btn.dataset.target;
          const step = parseFloat(btn.dataset.step);

          const input = document.getElementById(targetId);
          if (!input) return;

          let v = parseFloat(input.value) || 0;
          v += step;

          const min = parseFloat(input.min);
          const max = parseFloat(input.max);

          if (!isNaN(min)) v = Math.max(min, v);
          if (!isNaN(max)) v = Math.min(max, v);

          const stepStr = input.step || "1";
          const decimals = (stepStr.split(".")[1] || "").length;
          input.value = v.toFixed(decimals);

          input.dispatchEvent(new Event("input"));
        });
      });

      // Helfer: SVG ‚Üí Canvas

      function svgToCanvas(svgText, widthMM, heightMM, dpi = 300) {
        const mmToPx = (mm) => (mm / 25.4) * dpi;

        const wPx = mmToPx(widthMM);
        const hPx = mmToPx(heightMM);

        const canvas = document.createElement("canvas");
        canvas.width = wPx;
        canvas.height = hPx;

        const ctx = canvas.getContext("2d");

        return new Promise((resolve) => {
          const img = new Image();

          const blob = new Blob([svgText], {
            type: "image/svg+xml;charset=utf-8"
          });

          const url = URL.createObjectURL(blob);

          img.onload = () => {
            ctx.drawImage(img, 0, 0, wPx, hPx);
            URL.revokeObjectURL(url);
            resolve(canvas);
          };

          img.src = url;
        });
      }
      // END Helfer: SVG ‚Üí Canvas

      //---------- EXPORT ----------------
      document.getElementById("exportSingleSvg")?.addEventListener("click", () => {
        exportSingleStickerSVG();
      });

      function exportSingleStickerSVG() {
        const svgEl = document.getElementById("preview");
        if (!svgEl) {
          alert("Kein SVG gefunden");
          return;
        }

        // Ma√üe aus viewBox holen
        const vb = svgEl.getAttribute("viewBox").split(" ");
        const w = vb[2];
        const h = vb[3];

        // Clone bauen
        const clone = svgEl.cloneNode(true);

        clone.setAttribute("xmlns", "http://www.w3.org/2000/svg");
        clone.setAttribute("width", w + "mm");
        clone.setAttribute("height", h + "mm");
        clone.setAttribute("viewBox", `0 0 ${w} ${h}`);

        // Dateiname bauen
        // Dateiname bauen
        const fname = makeSheetFilename("svg");

        // Blob erzeugen
        const blob = new Blob(['<?xml version="1.0" encoding="UTF-8"?>\n' + clone.outerHTML], {
          type: "image/svg+xml"
        });

        const url = URL.createObjectURL(blob);

        // Download-Link
        const a = document.createElement("a");
        a.href = url;
        a.download = fname;

        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        URL.revokeObjectURL(url);
      }

      function downloadSVG(svgText, filename) {
        const blob = new Blob(['<?xml version="1.0" encoding="UTF-8"?>\n' + svgText], { type: "image/svg+xml" });

        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        URL.revokeObjectURL(url);
      }

      // -------------------- Sheet Export -----------------//

      // Sheet Analyse

      function analyzeSheet() {
        const sheetH = 177.8;
        const cols = 2;
        const rowGap = 3;

        const test = renderStickerSVG(0);
        const stickerH = Number(test.h);

        const mode = document.getElementById("numMode").value;
        const extraMode = document.getElementById("extraRowMode").value;

        const seriesCount =
          mode === "1-12"
            ? 12
            : mode === "1x1-6"
              ? 6
              : mode === "2x1-6"
                ? 12
                : mode === "2x1-3"
                  ? 6
                  : mode === "4x1-3"
                    ? 12
                    : 0;

        const seriesRows = Math.ceil(seriesCount / cols);

        const maxRows = Math.floor((sheetH - rowGap) / (stickerH + rowGap));

        const freeRowsTotal = Math.max(0, maxRows - seriesRows);

        // ---- AUTO CIRCLE REGEL ----
        const autoCircleRows = freeRowsTotal >= 2 ? 1 : 0;

        const userFreeRows = freeRowsTotal - autoCircleRows;

        const usedRows = seriesRows + autoCircleRows + (extraMode === "empty" ? 0 : userFreeRows);

        const info = `
    Gesamt m√∂glich: ${maxRows}<br>
    Serienreihen: ${seriesRows}<br>
    Auto CircleOnly: ${autoCircleRows}<br>
    Freie Reihen: ${userFreeRows}<br>
    Extra-Modus: ${extraMode}<br>
    Genutzt: ${usedRows}
  `;

        const el = document.getElementById("sheetInfo");
        if (el) el.innerHTML = info;

        const freeEl = document.getElementById("freeRowsVal");
        if (freeEl) freeEl.textContent = freeRowsTotal;
      }

      ["numMode", "extraRowMode"].forEach((id) => {
        document.getElementById(id)?.addEventListener("change", () => {
          updatePreview();
          analyzeSheet();
        });
      });

      // END Sheet Analyse

      document.getElementById("exportSheetSvg")?.addEventListener("click", exportSheetSVG);

      function buildSheetSVG() {
        const sheetH = 177.8; // 7 inch
        const sheetW = 101.6; // 4 inch

        const cols = 2;
        const rowGap = 3;

        const mode = document.getElementById("numMode")?.value || "";

        const seriesCount =
          mode === "1-12" ? 12 : mode === "1x1-6" ? 6 : mode === "2x1-6" ? 12 : mode === "4x1-3" ? 12 : 0;

        const extraMode = document.getElementById("extraRowMode")?.value || "empty";

        const cellW = sheetW / cols;

        // --- Stickergr√∂√üe messen ---
        const test = renderStickerSVG(0);
        const stickerH = Number(test.h);

        // --- Reihenberechnung ---
        const seriesRows = Math.ceil(seriesCount / cols);

        const maxRows = Math.floor((sheetH - rowGap) / (stickerH + rowGap));

        let freeRows = Math.max(0, maxRows - seriesRows);

        // --- Auto circle rule ---
        let autoCircleRows = 0;

        if (freeRows >= 2) {
          autoCircleRows = 1;
          freeRows--;
        }

        let content = "";

        // ---------------- MAIN SERIES ----------------
        const totalMain = seriesRows * cols;

        for (let i = 0; i < totalMain; i++) {
          const isExtra = i >= seriesCount;

          const { svg, w, h } = renderStickerSVG(i, {
            suppressNumber: isExtra
          });

          const col = i % cols;
          const row = Math.floor(i / cols);

          const cellX = col * cellW;
          const cellY = rowGap + row * (stickerH + rowGap);

          const x = cellX + (cellW - w) / 2;
          const y = cellY;

          content += `<g transform="translate(${x},${y})">${svg}</g>`;
        }

        let nextRowIndex = seriesRows;

        // ---------------- AUTO CIRCLE ROW ----------------
        if (autoCircleRows === 1) {
          for (let c = 0; c < cols; c++) {
            const { svg, w, h } = renderStickerSVG(-1, {
              suppressNumber: true,
              forceCircle: true
            });

            const cellX = c * cellW;
            const cellY = rowGap + nextRowIndex * (stickerH + rowGap);

            const x = cellX + (cellW - w) / 2;
            const y = cellY;

            content += `<g transform="translate(${x},${y})">${svg}</g>`;
          }

          nextRowIndex++;
        }

        // ---------------- USER EXTRA ROWS ----------------
        if (extraMode === "circleOnly") {
          for (let r = 0; r < freeRows; r++) {
            for (let c = 0; c < cols; c++) {
              const { svg, w, h } = renderStickerSVG(-1, {
                suppressNumber: true,
                forceCircle: true
              });

              const cellX = c * cellW;
              const cellY = rowGap + (nextRowIndex + r) * (stickerH + rowGap);

              const x = cellX + (cellW - w) / 2;
              const y = cellY;

              content += `<g transform="translate(${x},${y})">${svg}</g>`;
            }
          }
        }

        // ---------------- META BLOCK ----------------
        if (extraMode === "meta") {
          const arrowType = document.getElementById("arrowType")?.value || "";
          const spine = document.getElementById("spine")?.value || "";
          const nameVal = document.getElementById("name")?.value || "";
          const modeLabel = document.getElementById("numMode")?.value || "";

          const usedH = nextRowIndex * stickerH + (nextRowIndex + 1) * rowGap;

          const freeH = sheetH - usedH;

          if (freeH > 15) {
            const pad = 8;
            const metaY = usedH + rowGap;

            content += `
<rect x="0"
      y="${metaY}"
      width="${sheetW}"
      height="${freeH}"
      fill="white"
      stroke="#999"
      stroke-width="2"/>`;

            let ty = metaY + pad + 8;
            const lh = 7;

            content += `
<g font-family="Arial" font-size="5" fill="black">
  <text x="${pad}" y="${ty}">Name: ${nameVal}</text>
  <text x="${pad}" y="${(ty += lh)}">Arrow: ${arrowType}</text>
  <text x="${pad}" y="${(ty += lh)}">Spine: ${spine}</text>
  <text x="${pad}" y="${(ty += lh)}">Mode: ${modeLabel}</text>
  <text x="${pad}" y="${(ty += lh)}">Date: __________</text>
</g>`;
          }
        }

        // ---- Preset-ID unten auf dem Bogen ----
        if (currentPresetId) {
          const pidY = sheetH - 4;

          content += `
<text x="${sheetW / 2}"
      y="${pidY}"
      text-anchor="middle"
      font-size="4"
      fill="#444"
      font-family="Arial">
Sticker ID: ${currentPresetId}
</text>`;
        }
        // END Preset-ID unten auf dem Bogen ----

        const sheetSVG = `
<svg xmlns="http://www.w3.org/2000/svg"
     width="${sheetW}mm"
     height="${sheetH}mm"
     viewBox="0 0 ${sheetW} ${sheetH}">
${content}
</svg>`;

        return {
          svg: sheetSVG,
          wMM: sheetW,
          hMM: sheetH
        };
      }

      // Confirm Export ohne Preset
      function confirmExportWithoutPreset() {
        if (currentPresetId) return true;

        return confirm(
          "‚ö†Ô∏è Kein Preset gespeichert!\n\n" +
            "Wenn du jetzt exportierst, kann dieser Sticker sp√§ter nicht mehr eindeutig zugeordnet werden.\n\n" +
            "M√∂chtest du trotzdem fortfahren?"
        );
      }

      // END Confirm Export ohne Preset

      function exportSheetSVG() {
        if (!confirmExportWithoutPreset()) return;

        const { svg } = buildSheetSVG();
        downloadSVG(svg, makeSheetFilename("svg"));
      }

      //---------- END SVG EXPORT ------------

      // PNG-Export
      document.getElementById("exportSheetPng")?.addEventListener("click", exportSheetPNG);

      async function exportSheetPNG() {
        if (!confirmExportWithoutPreset()) return;

        const { svg, wMM, hMM } = buildSheetSVG();
        // üëÜ gleiche Funktion wie exportSheetSVG nutzt

        const canvas = await svgToCanvas(svg, wMM, hMM);

        const link = document.createElement("a");
        link.download = makeSheetFilename("png");
        link.href = canvas.toDataURL("image/png");

        link.click();
      }
      // END PNG-Export

      // PDF Export

      document.getElementById("exportSheetPdf")?.addEventListener("click", exportSheetPDF);

      async function exportSheetPDF() {
        if (!confirmExportWithoutPreset()) return;

        const { svg, wMM, hMM } = buildSheetSVG();

        const canvas = await svgToCanvas(svg, wMM, hMM, 300);

        const imgData = canvas.toDataURL("image/png");

        const { jsPDF } = window.jspdf;

        const pdf = new jsPDF({
          orientation: wMM > hMM ? "landscape" : "portrait",
          unit: "mm",
          format: [wMM, hMM]
        });

        pdf.addImage(imgData, "PNG", 0, 0, wMM, hMM);

        pdf.save(makeSheetFilename("pdf"));
      }

      // END PDF Export

      // Dateinamen bauen

      function makeSheetFilename(ext) {
        const name = safeFilePart(document.getElementById("name")?.value || "Sticker");

        const arrow = safeFilePart(document.getElementById("arrowType")?.value || "Arrow");

        const spine = safeFilePart(document.getElementById("spine")?.value || "Spine");

        const mode = safeFilePart(document.getElementById("numMode")?.value || "Mode");

        const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

        return `${name}_${arrow}_${spine}_${mode}_${today}.${ext}`;
      }
      // END Dateinamen bauen
      //
      // Preset bauen

      function collectPresetData() {
        if (!currentPresetId) {
          currentPresetId = generatePresetId();
        }

        const data = {
          presetId: currentPresetId,
          created: new Date().toISOString(),

          values: {}
        };

        document.querySelectorAll("input,select").forEach((el) => {
          if (!el.id) return;

          if (el.type === "checkbox") data.values[el.id] = el.checked;
          else if (el.type === "radio") {
            if (el.checked) data.values[el.name] = el.value;
          } else data.values[el.id] = el.value;
        });

        return data;
      }

      // End Preset bauen
      // Preset speichern

      function savePresetToFile() {
        const preset = collectPresetData();

        const blob = new Blob([JSON.stringify(preset, null, 2)], { type: "application/json" });

        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `${preset.presetId}.json`;

        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        URL.revokeObjectURL(url);
      }

      // END Preset speichern

      // Preset aus Datei laden

      function loadPresetFromFile(file) {
        const reader = new FileReader();

        reader.onload = () => {
          const preset = JSON.parse(reader.result);

          currentPresetId = preset.presetId || null;

          Object.entries(preset.values).forEach(([id, val]) => {
            const el = document.getElementById(id);

            if (!el) return;

            if (el.type === "checkbox") el.checked = val;
            else el.value = val;

            el.dispatchEvent(new Event("input"));
          });

          updatePreview();
        };

        reader.readAsText(file);
      }

      // END Preset aus Datei laden

// ---------------- SESSION AUTOSAVE ----------------

const AUTO_SAVE_KEY = "arrowSticker_session";
const DEFAULT_KEY = "arrowSticker_defaults";

// üëâ sammelt aktuelle UI-Werte
function collectSessionData() {
  const data = {};

  document.querySelectorAll("input,select").forEach((el) => {
    if (!el.id && !el.name) return;

    const key = el.id || el.name;

    if (el.type === "checkbox") data[key] = el.checked;
    else if (el.type === "radio") {
      if (el.checked) data[key] = el.value;
    } else data[key] = el.value;
  });

  return data;
}

// üëâ speichert laufend
function saveSession() {
  const data = collectSessionData();
  localStorage.setItem(AUTO_SAVE_KEY, JSON.stringify(data));
}

// üëâ Restore beim Laden
function restoreSession() {
  const raw = localStorage.getItem(AUTO_SAVE_KEY);
  if (!raw) return false;

  const data = JSON.parse(raw);

  Object.entries(data).forEach(([key, val]) => {
    const el =
      document.getElementById(key) ||
      document.querySelector(`input[name="${key}"]`);

    if (!el) return;

    if (el.type === "checkbox") el.checked = val;
    else el.value = val;
  });

  updatePreview();
  return true;
}

// üëâ Reset ‚Üí Defaults
function resetToDefaults() {
  const raw = localStorage.getItem(DEFAULT_KEY);
  if (!raw) {
    alert("Keine Defaults gefunden ‚Äì Seite neu laden.");
    return;
  }

  const data = JSON.parse(raw);

  Object.entries(data).forEach(([key, val]) => {
    const el =
      document.getElementById(key) ||
      document.querySelector(`input[name="${key}"]`);

    if (!el) return;

    if (el.type === "checkbox") el.checked = val;
    else el.value = val;
  });

  updatePreview();
  saveSession();
}

// ---------------- END SESSION AUTOSAVE ----------------
      
      
      
      
      
      
      // ---------- BIND INPUTS ----------
      const bindIds = [
        "name",
        "count",
        "stickerW",
        "stickerIndex",
        "arrowType",
        "spine",
        "arrowDia",
        "extraH",
        "bgColor",
        "frameTop",
        "frameBottom",
        "frameLeft",
        "frameRight",
        "frameColor",
        "frameWidth",
        "iconOn",
        "emoji",
        "iconSize",
        "iconGap",
        "iconVOffset",
        "circleOn",
        "circleShape",
        "circleDia",
        "capsuleW",
        "circleGap",
        "circleVOffset",
        "circleFill",
        "circleStroke",
        "numMode",
        "numColor",
        "numVOffset",
        "nameColor",
        "fontFamily",
        "fontSize",
        "fontBold",
        "fontBoldNum",
        "textShift"
      ];

      bindIds.forEach((id) => {
        const el = document.getElementById(id);
        if (el)
          el.addEventListener("input", () => {
            updatePreview();
            saveSession();
          });
      });

document
  .querySelectorAll('input[name="iconSide"],input[name="circleSide"]')
  .forEach((r) =>
    r.addEventListener("change", () => {
      updatePreview();
      saveSession();
    })
  );

      updatePreview();

      document.addEventListener("DOMContentLoaded", () => {
        
        const DEFAULT_KEY = "arrowSticker_defaults";

        // Beim ersten Laden Defaults speichern
        if (!localStorage.getItem(DEFAULT_KEY)) {
          const defaults = collectSessionData();
          localStorage.setItem(DEFAULT_KEY, JSON.stringify(defaults));
        }     

        const tabs = document.querySelectorAll(".tab");
        const panels = document.querySelectorAll(".panel");

        if (!tabs.length) return;

        // alles aus
        tabs.forEach((t) => t.classList.remove("active"));
        panels.forEach((p) => (p.style.display = "none"));

        // ersten Tab aktiv
        const firstTab = tabs[0];
        firstTab.classList.add("active");

        const firstPanelId = firstTab.dataset.tab;
        const panel = document.getElementById(firstPanelId);
        if (panel) panel.style.display = "block";

        const analyzeToggle = document.getElementById("toggleAnalyze");
        const analyzeBox = document.getElementById("analyzeBox");

        if (analyzeToggle && analyzeBox) {
          const updateAnalyzeVisibility = () => {
            analyzeBox.style.display = analyzeToggle.checked ? "block" : "none";
          };

          analyzeToggle.addEventListener("change", updateAnalyzeVisibility);

          // initialer Zustand
          updateAnalyzeVisibility();
        }

        // Save Loda Preset Button

        document.getElementById("savePresetBtn")?.addEventListener("click", savePresetToFile);

        document.getElementById("loadPresetFile")?.addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (file) loadPresetFromFile(file);
        });
        
        
        // -------- SESSION RESTORE --------
        const restored = restoreSession();

        if (restored) {
          const banner = document.getElementById("sessionBanner");
          if (banner) {
            banner.classList.remove("hidden");

            setTimeout(() => {
              banner.classList.add("hidden");
            }, 4000);
          }
        }
        
        
        
        if (restored) {
          console.log("Session wiederhergestellt");
        }
        // --------------------------------

        // Reset Button
        document
          .getElementById("resetSessionBtn")
          ?.addEventListener("click", () => {
            if (confirm("Session wirklich zur√ºcksetzen?")) {
              resetToDefaults();
            }
          });
        
        
        // END Save load Preset Button
      });
    </script>
  </body>
</html>
